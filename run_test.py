import streamlit as st
from streamlit_mermaid import st_mermaid
import re
import uuid



def mermaid(report: str, add_str: str = ""):
    with st.chat_message("assistant"):
        st.markdown(f"==== FINAL REPORT ({add_str}) ====")
        if "```mermaid" in report:
            parts = re.split(r'(```mermaid.*?```)', report, flags=re.DOTALL)
            for part in parts:
                if not part.strip():
                    continue
                if part.strip().startswith('```mermaid'):
                    code = re.search(r'```mermaid\s*(.*?)\s*```', part, re.DOTALL).group(1)
                    st_mermaid(code, key=str(uuid.uuid4()))
                else:
                    st.markdown(part)

        else:
            st.markdown(report)

report = """飓风季对石油供需的瞬时扰动具有显著的地理敏感性与市场预期驱动特征。美国墨西哥湾沿岸作为全球原油生产与炼化的核心区域，其原油产量占全美总产量的55.8%，炼油产能达951.4万桶/日。根据历史数据，该地区在飓风活跃季（6月至10月）的原油产量波动呈现规律性：2023年6月产量为278,003桶/日，至同年8月回升至292,284桶/日；而2024年同期数据显示，6月产量降至291,401桶/日，7月则恢复至300,155桶/日。这种周期性波动与飓风登陆路径密切相关——四级以上飓风若直接登陆墨西哥湾，可导致原油开采设施关闭、炼厂停工及海上运输中断。例如2005年卡特里娜飓风期间，油价在登陆前一周涨幅达11.3%，但2017年哈维飓风因应急体系完善，仅造成3.5亿桶/日炼油产能的短暂中断。2024年飓风贝丽尔的案例更具典型性：尽管其登陆时已减弱为热带风暴，但壳牌公司仍暂停墨西哥湾部分钻井作业，引发市场对三季度活跃飓风季的担忧，EIA预测的25个命名风暴可能扩大原油去库幅度至402万桶/周。  

寒潮对石油市场的扰动则表现为供给压缩与需求激增的双向冲击。2024年1月美国德州北部暴雪导致原油产量环比下降8.7%，从28.27万桶/日骤降至27.44万桶/日，叠加炼厂开工率下降12个百分点，直接推升WTI原油期货主力合约结算价从536.1美元/桶攀升至602.7美元/桶。需求端方面，寒潮引发的取暖用油需求具有显著短期效应：2025年首周美国商业部门残余燃油消费量环比激增13.73%，取暖油库存去库幅度达11.84%。不过这种刺激存在明显双刃剑效应，2024年1月API数据显示，尽管原油库存减少402万桶，但汽油库存却意外累积5.11%，反映出极端天气对产业链不同环节的差异化影响。从库存数据动态来看，2025年2月取暖油库存波动剧烈，单周库存增减幅度最高达17.43%，最低为-5.64%，这种剧烈震荡与寒潮持续时间呈现强相关性。  

季节性因素与政策响应的交互作用进一步复杂化了气候扰动的影响机制。飓风活跃季（6-10月）与冬季寒潮形成周期性风险窗口，2024年三季度因预测飓风活跃度增强，WTI原油近月持仓量从6月的25.57万手激增至8月的30.42万手，显示市场提前布局对冲策略。政策层面，美国战略石油储备（SPR）释放机制已形成成熟缓冲体系，2017年哈维飓风后SPR释放量达500万桶，成功将油价波动幅度控制在7%以内。OPEC+的动态调整同样关键，2024年推迟220万桶/日的增产计划，使基准油价在寒潮期间维持于560-620美元/桶区间。从基础设施韧性角度看，飓风导致的电力中断成本不容忽视：杜克能源因2024年飓风季损失24亿-29亿美元，间接导致墨西哥湾炼厂复工速度延迟3-5个工作日，这种连锁效应在2024年8月的库存数据中体现为可用库容量单周减少15.19%，注册仓单数量波动幅度达199万手。  

```mermaid
gantt
    title 2024年气候事件与油价波动时间轴
    dateFormat  YYYY-MM-DD
    section 飓风季
    贝丽尔飓风登陆     :active, 2024-07-15, 3d
    墨西哥湾产量下降   :2024-06-30, 30d
    炼厂设备关闭       :2024-08-01, 14d
    section 寒潮
    德州暴雪事件       :2024-01-10, 10d
    取暖油库存峰值     :2025-01-31, 7d
    管道运输受限       :2024-02-14, 14d
    section 政策响应
    SPR储备释放       :2024-09-01, 21d
    OPEC+增产推迟     :2024-11-30, 30d
```

| 气候类型   | 影响周期   | 供给端冲击指标          | 需求端冲击指标          | 典型事件油价波动幅度 |
|------------|------------|-------------------------|-------------------------|----------------------|
| 四级飓风   | 7-14天     | 原油产量下降12-15%      | 炼油需求减少8-10%       | +9.2%~+15.6%         |
| 热带风暴   | 3-7天      | 海上钻井平台关闭率30%   | 汽油库存累积5-7%        | +3.8%~+6.4%          |
| 冬季寒潮   | 10-21天    | 陆上管道运力下降40%     | 取暖油消费激增20-25%    | +12.1%~+18.7%        |
| 持续暴雪   | 15-30天    | 炼厂开工率下降25%       | 柴油库存去库速率加快2倍 | +7.9%~+14.3%         |  

气候异常对油价的扰动本质上是短期供需错配与市场情绪共振的结果。从墨西哥湾原油产量月度数据可见，2024年飓风季造成的产量波动幅度已从2005年的±18%收窄至±6%，显示基础设施抗灾能力的提升。然而寒潮引发的需求侧波动反而加剧，2025年1月取暖油库存周转天数从常态的22天缩短至15天，这种结构性变化要求投资者更精准把握气候事件的时间窗口。当前市场已形成双重博弈机制：一方面交易员根据NOAA飓风路径预测模型提前5-7天布局，另一方面炼厂通过提高9-11月检修频率来规避风险。这种动态平衡使得气候因素对油价的影响更多体现为脉冲式波动而非趋势性改变，2024年WTI原油期货的30日波动率在飓风季维持在24%-28%，显著高于年均18%的水平，但未突破30%的风险阈值。
"""


mermaid(report)
mermaid(report)
st.text("# safdd\n - asdfads")
st.markdown("# safdd\n - asdfads")
st.write("# safdd\n - asdfads")